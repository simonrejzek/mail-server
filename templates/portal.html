<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Disctools Mail</title>
  <meta name="description" content="Password-gated inbox portal for @{{ domain_name }}">
  <meta name="robots" content="noindex,nofollow">
  <link rel="icon" type="image/png" href="/axilon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg0:#070812;
      --bg1:#0b0c16;
      --panel: rgba(16, 18, 28, 0.72);
      --panel2: rgba(18, 20, 31, 0.92);
      --border: rgba(255,255,255,0.08);
      --text: #eef2ff;
      --muted: rgba(226,232,240,0.62);
      --muted2: rgba(226,232,240,0.44);
      --shadow: 0 22px 70px rgba(0,0,0,0.45);
      --shadow2: 0 14px 40px rgba(0,0,0,0.35);
      --radius: 16px;
      --radius2: 12px;
      --accent: #18d5a3;
      --accent2: #60a5fa;
      --danger: #ef4444;
      --warn: #f59e0b;
      --mono: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --font: "Poppins", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(900px 600px at 18% 14%, rgba(24,213,163,0.14), transparent 60%),
        radial-gradient(900px 600px at 85% 10%, rgba(96,165,250,0.18), transparent 55%),
        radial-gradient(900px 700px at 60% 90%, rgba(99,102,241,0.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .noise{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.25;
      background-image: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 0);
      background-size: 3px 3px;
      z-index:0;
    }
    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(14px);
      background: linear-gradient(90deg, rgba(12,14,22,0.88), rgba(10,12,18,0.92));
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow2);
    }
    .topbar-inner{
      max-width: 1320px;
      margin: 0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 220px;
    }
    .mark{
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(24,213,163,0.24), rgba(96,165,250,0.18));
      border: 1px solid rgba(255,255,255,0.12);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 800;
      letter-spacing: -0.5px;
      color: rgba(255,255,255,0.96);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      user-select:none;
    }
    .brand-name{font-size: 15px; font-weight: 700; letter-spacing: -0.2px}
    .brand-sub{font-size: 12px; color: var(--muted2)}
    .top-actions{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      font-size: 12px;
      max-width: 520px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .dot{
      width: 10px; height: 10px;
      border-radius: 50%;
      background: rgba(34,197,94,1);
      box-shadow: 0 0 14px rgba(34,197,94,0.6);
    }
    .chip strong{color: rgba(255,255,255,0.9); font-weight: 700}
    .btn{
      appearance:none;
      border: 1px solid transparent;
      border-radius: 12px;
      padding: 10px 12px;
      background: linear-gradient(135deg, rgba(255,255,255,0.96), rgba(218,232,255,0.96));
      color: rgba(10,12,18,1);
      font-weight: 700;
      font-size: 13px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, opacity .2s ease, border-color .12s ease;
      box-shadow: 0 12px 32px rgba(0,0,0,0.22);
    }
    .btn:hover{transform: translateY(-1px); box-shadow: 0 16px 42px rgba(0,0,0,0.24)}
    .btn:active{transform: translateY(0)}
    .btn:disabled{opacity: .55; cursor:not-allowed; transform:none; box-shadow:none}
    .btn.ghost{
      background: rgba(255,255,255,0.05);
      border-color: var(--border);
      color: rgba(255,255,255,0.88);
      box-shadow:none;
    }
    .btn.ghost:hover{border-color: rgba(255,255,255,0.16)}
    .btn.danger{
      background: linear-gradient(135deg, rgba(239,68,68,1), rgba(220,38,38,1));
      color: #fff;
      box-shadow: 0 12px 32px rgba(239,68,68,0.18);
    }
    .btn.danger:hover{box-shadow: 0 16px 42px rgba(239,68,68,0.22)}
    .layout{
      max-width: 1320px;
      margin: 0 auto;
      padding: 18px;
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 16px;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr}
      .brand{min-width: unset}
      .topbar-inner{padding: 12px 14px}
    }
    .panel{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }
    .panel-inner{padding: 14px}
    .panel-title{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
      margin: 0 0 10px;
      font-size: 13px;
      font-weight: 800;
      letter-spacing: 0.2px;
      color: rgba(255,255,255,0.86);
      text-transform: uppercase;
    }
    .muted{color: var(--muted); font-size: 13px}
    .mono{font-family: var(--mono)}
    .field{margin-top: 12px}
    label{
      display:block;
      margin: 0 0 6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
    }
    input, select{
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: var(--panel2);
      color: rgba(255,255,255,0.92);
      padding: 12px 12px;
      outline: none;
      transition: border-color .12s ease, box-shadow .12s ease;
      font-family: var(--font);
      font-size: 13px;
    }
    input.mono{font-family: var(--mono)}
    input:focus, select:focus{
      border-color: rgba(24,213,163,0.45);
      box-shadow: 0 0 0 3px rgba(24,213,163,0.12);
    }
    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }
    .row.nowrap{flex-wrap: nowrap}
    .suffix{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.72);
      font-size: 12px;
      white-space: nowrap;
    }
    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .hint{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(24,213,163,0.22);
      background: rgba(24,213,163,0.08);
      color: rgba(24,213,163,0.72);
      font-size: 12px;
    }
    .address-list, .message-list{
      display:flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
      max-height: 420px;
      overflow:auto;
      padding-right: 4px;
    }
    .address-item{
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      display:flex;
      justify-content:space-between;
      gap: 10px;
      cursor:pointer;
      transition: border-color .12s ease, background .12s ease;
    }
    .address-item:hover{border-color: rgba(255,255,255,0.16); background: rgba(255,255,255,0.04)}
    .address-item.active{
      border-color: rgba(24,213,163,0.35);
      background: rgba(24,213,163,0.08);
    }
    .address-main{min-width: 0}
    .address-email{
      font-weight: 800;
      font-size: 13px;
      color: rgba(255,255,255,0.92);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .address-meta{margin-top: 2px; font-size: 12px; color: var(--muted2)}
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      flex-shrink:0;
    }
    .pill.danger{border-color: rgba(239,68,68,0.28); background: rgba(239,68,68,0.10); color: rgba(239,68,68,0.9)}

    .inbox{
      display:flex;
      flex-direction: column;
      min-height: 640px;
    }
    .inbox-top{
      padding: 14px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .inbox-top .panel-title{margin:0}
    .inbox-top .row{margin-left:auto}
    .inbox-body{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 0;
      min-height: 0;
      flex: 1;
    }
    @media (max-width: 1180px){
      .inbox-body{grid-template-columns: 1fr}
    }
    .message-list{
      padding: 12px;
      border-right: 1px solid var(--border);
      max-height: none;
      height: 100%;
      overflow:auto;
    }
    @media (max-width: 1180px){
      .message-list{border-right: none; border-bottom: 1px solid var(--border); max-height: 360px}
    }
    .message-item{
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      cursor:pointer;
      transition: border-color .12s ease, background .12s ease;
      display:flex;
      gap: 10px;
    }
    .message-item:hover{border-color: rgba(255,255,255,0.16); background: rgba(255,255,255,0.04)}
    .message-item.selected{border-color: rgba(96,165,250,0.36); background: rgba(96,165,250,0.10)}
    .message-main{flex: 1; min-width: 0}
    .message-subject{font-weight: 800; font-size: 13px; color: rgba(255,255,255,0.92); overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .message-from{margin-top: 2px; font-size: 12px; color: var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .message-preview{margin-top: 6px; font-size: 12px; color: var(--muted2); overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .message-time{flex-shrink:0; font-size: 12px; color: var(--muted2)}

    .viewer{
      display:flex;
      flex-direction: column;
      min-height: 0;
    }
    .viewer-head{
      padding: 14px;
      border-bottom: 1px solid var(--border);
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .viewer-subject{
      font-size: 18px;
      font-weight: 800;
      letter-spacing: -0.3px;
      color: rgba(255,255,255,0.94);
      overflow-wrap:anywhere;
    }
    .viewer-meta{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 12px;
    }
    .viewer-meta span{display:inline-flex; align-items:center; gap: 6px}
    .viewer-content{
      position: relative;
      flex: 1;
      min-height: 0;
      padding: 0;
      background: rgba(255,255,255,0.02);
    }
    .viewer-frame{
      width: 100%;
      height: 100%;
      border: 0;
      background: #fff;
      display:none;
    }
    .viewer-empty{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      color: var(--muted);
      font-size: 13px;
      text-align:center;
    }
    .empty{
      margin-top: 10px;
      padding: 14px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.03);
      color: var(--muted);
      font-size: 13px;
      text-align:center;
    }
    .gate{
      position: fixed;
      inset:0;
      z-index: 50;
      background: rgba(5,6,10,0.82);
      backdrop-filter: blur(14px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .gate-card{
      width: 100%;
      max-width: 420px;
      background: rgba(16,18,28,0.92);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .gate-title{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: -0.3px;
      margin: 0 0 4px;
    }
    .gate-actions{margin-top: 12px; display:flex; gap: 10px}
    .gate-error{
      margin-top: 10px;
      color: rgba(239,68,68,0.95);
      font-size: 13px;
      display:none;
    }
    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 60;
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(18,20,31,0.92);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: var(--shadow2);
      color: rgba(255,255,255,0.92);
      max-width: 320px;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity .15s ease, transform .15s ease;
      pointer-events:none;
      font-size: 13px;
    }
    .toast.show{opacity: 1; transform: translateY(0)}
    .toast.error{border-color: rgba(239,68,68,0.35)}
    .toast.ok{border-color: rgba(24,213,163,0.35)}
  </style>
</head>
<body>
  <div class="noise"></div>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="mark" aria-hidden="true">D</div>
        <div>
          <div class="brand-name">Disctools Mail</div>
          <div class="brand-sub">Portal • <span class="mono">@{{ domain_name }}</span></div>
        </div>
      </div>

      <div class="top-actions">
        <div class="chip" id="activeChip" title="Current inbox">
          <span class="dot" aria-hidden="true"></span>
          <span id="activeChipText">All inboxes</span>
        </div>
        <button class="btn ghost" id="refreshInboxBtn" type="button">Refresh</button>
        <button class="btn ghost" id="copyEmailBtn" type="button">Copy inbox</button>
        <button class="btn danger" id="expireInboxBtn" type="button">Expire</button>
      </div>
    </div>
  </div>

  <div class="layout">
    <aside>
      <div class="panel">
        <div class="panel-inner">
          <div class="panel-title">Open Inbox <span class="pill mono">@{{ domain_name }}</span></div>
          <div class="field">
            <label for="openInboxInput">Email</label>
            <div class="row nowrap">
              <input id="openInboxInput" class="mono" placeholder="test@{{ domain_name }}" autocomplete="off">
              <button class="btn" id="openInboxBtn" type="button">Open</button>
            </div>
            <div class="actions">
              <button class="btn ghost" id="viewAllBtn" type="button">View all</button>
              <button class="btn ghost" id="syncAddressesBtn" type="button">Sync addresses</button>
            </div>
          </div>
          <div class="hint">
            Tip: open any inbox (e.g. <span class="mono">test@{{ domain_name }}</span>) with the portal password.
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top: 16px;">
        <div class="panel-inner">
          <div class="panel-title">Create Mailbox</div>
          <div class="field">
            <label for="customHandleInput">Custom handle (optional)</label>
            <div class="row nowrap">
              <input id="customHandleInput" class="mono" placeholder="myname" autocomplete="off">
              <span class="suffix mono">@{{ domain_name }}</span>
            </div>
          </div>
          <div class="field">
            <label for="expirySelect">Expiry</label>
            <select id="expirySelect">
              <option value="">Never</option>
              <option value="30m">30 minutes</option>
              <option value="1h">1 hour</option>
              <option value="6h">6 hours</option>
              <option value="1d">1 day</option>
              <option value="3d">3 days</option>
              <option value="7d">7 days</option>
            </select>
          </div>
          <div class="actions">
            <button class="btn" id="generateRandomBtn" type="button">Generate random</button>
            <button class="btn ghost" id="generateCustomBtn" type="button">Create custom</button>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top: 16px;">
        <div class="panel-inner">
          <div class="panel-title">Saved Addresses <span class="pill" id="addressCount">0</span></div>
          <div class="field">
            <label for="addressSearch">Search</label>
            <input id="addressSearch" placeholder="Filter saved addresses">
          </div>
          <div class="address-list" id="addressList" aria-label="Saved addresses list"></div>
          <div class="empty" id="addressEmpty">No saved addresses yet.</div>
        </div>
      </div>
    </aside>

    <main>
      <div class="panel inbox">
        <div class="inbox-top">
          <div>
            <div class="panel-title">Inbox</div>
            <div class="muted" id="inboxSubtitle">No inbox loaded.</div>
          </div>
          <div class="row">
            <input id="messageSearch" placeholder="Search messages">
            <button class="btn ghost" id="clearPasswordBtn" type="button">Sign out</button>
          </div>
        </div>
        <div class="inbox-body">
          <div class="message-list" id="messageList" aria-label="Message list"></div>
          <div class="viewer">
            <div class="viewer-head">
              <div class="viewer-subject" id="viewerSubject">Select a message</div>
              <div class="viewer-meta" id="viewerMeta"></div>
            </div>
            <div class="viewer-content">
              <iframe class="viewer-frame" id="viewerFrame" sandbox="allow-popups" loading="lazy" title="Email content"></iframe>
              <div class="viewer-empty" id="viewerEmpty">Select a message to view it here.</div>
            </div>
          </div>
        </div>
        <div class="empty" id="inboxEmpty">No messages yet.</div>
      </div>
    </main>
  </div>

  <div class="gate" id="gate">
    <div class="gate-card">
      <div class="gate-title">Unlock portal</div>
      <div class="muted">Enter the shared password to view and manage inboxes.</div>
      <div class="field">
        <label for="gatePassword">Portal password</label>
        <input id="gatePassword" type="password" autocomplete="current-password" placeholder="••••••••">
      </div>
      <div class="gate-actions">
        <button class="btn" id="unlockBtn" type="button">Unlock</button>
        <button class="btn ghost" id="gateClearBtn" type="button">Clear</button>
      </div>
      <div class="gate-error" id="gateError"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const domain = {{ domain_name|tojson }};

    const state = {
      portalPassword: '',
      activeInbox: '',
      addresses: [],
      emails: [],
      selectedId: null,
      messageSearch: '',
      addressSearch: ''
    };

    const els = {
      activeChipText: document.getElementById('activeChipText'),
      inboxSubtitle: document.getElementById('inboxSubtitle'),
      addressCount: document.getElementById('addressCount'),

      gate: document.getElementById('gate'),
      gatePassword: document.getElementById('gatePassword'),
      gateError: document.getElementById('gateError'),

      toast: document.getElementById('toast'),

      openInboxInput: document.getElementById('openInboxInput'),
      customHandleInput: document.getElementById('customHandleInput'),
      expirySelect: document.getElementById('expirySelect'),

      addressSearch: document.getElementById('addressSearch'),
      addressList: document.getElementById('addressList'),
      addressEmpty: document.getElementById('addressEmpty'),

      messageSearch: document.getElementById('messageSearch'),
      messageList: document.getElementById('messageList'),
      inboxEmpty: document.getElementById('inboxEmpty'),

      viewerSubject: document.getElementById('viewerSubject'),
      viewerMeta: document.getElementById('viewerMeta'),
      viewerFrame: document.getElementById('viewerFrame'),
      viewerEmpty: document.getElementById('viewerEmpty')
    };

    function showToast(message, tone = 'ok') {
      els.toast.textContent = message;
      els.toast.className = 'toast ' + (tone === 'error' ? 'error' : 'ok');
      els.toast.classList.add('show');
      window.clearTimeout(showToast._t);
      showToast._t = window.setTimeout(() => els.toast.classList.remove('show'), 2600);
    }

    function setGateError(message) {
      els.gateError.textContent = message;
      els.gateError.style.display = message ? 'block' : 'none';
    }

    async function apiFetch(url, options = {}) {
      const opts = Object.assign({ headers: {} }, options);
      opts.headers = Object.assign({}, opts.headers, {
        'Content-Type': 'application/json',
        'X-Portal-Password': state.portalPassword
      });
      const res = await fetch(url, opts);
      let data = {};
      try { data = await res.json(); } catch (err) {}
      if (!res.ok) {
        if (res.status === 401 || res.status === 403) throw new Error('auth');
        throw new Error(data.error || 'Request failed');
      }
      return data;
    }

    function formatDate(value) {
      if (!value) return '';
      const d = new Date(value);
      return isNaN(d.getTime()) ? value : d.toLocaleString();
    }

    function formatShortDate(value) {
      if (!value) return '';
      const d = new Date(value);
      if (isNaN(d.getTime())) return value;
      return d.toLocaleString(undefined, { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    function varMono() { return "'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace"; }
    function varSans() { return "-apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif"; }

    function looksLikeRawEmail(value) {
      if (!value) return false;
      const v = String(value);
      const indicators = ['MIME-Version:', 'Content-Type:', 'Received:', 'DKIM-Signature:', 'ARC-'];
      let hits = 0;
      for (const indicator of indicators) {
        if (v.includes(indicator)) hits += 1;
      }
      return hits >= 2;
    }

    function escapeRegExp(value) {
      return String(value).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function normalizeRawForParsing(raw) {
      if (!raw) return '';
      const v = String(raw);
      const newlineCount = (v.match(/\\n/g) || []).length;
      if (newlineCount >= 3) return v;
      // Some payloads might end up flattened; re-insert a few breaks before obvious tokens.
      return v
        .replace(/\\s+(--[0-9A-Za-z]{6,})/g, '\\n$1')
        .replace(/\\s+(Content-Type:)/g, '\\n$1')
        .replace(/\\s+(MIME-Version:)/g, '\\n$1')
        .replace(/\\s+(From:)/g, '\\n$1')
        .replace(/\\s+(To:)/g, '\\n$1')
        .replace(/\\s+(Subject:)/g, '\\n$1');
    }

    function extractPartByBoundary(raw, contentType) {
      const normalized = normalizeRawForParsing(raw);
      const boundaryMatch = normalized.match(/boundary="?([^"\\s;]+)"?/i);
      if (!boundaryMatch) return '';
      const boundary = boundaryMatch[1];
      const parts = normalized.split(new RegExp(`--${escapeRegExp(boundary)}`));
      for (const part of parts) {
        if (new RegExp(`Content-Type:\\\\s*${escapeRegExp(contentType)}`, 'i').test(part)) {
          const split = part.split(/\\r?\\n\\r?\\n/);
          if (split.length > 1) return split.slice(1).join('\\n\\n').trim();
        }
      }
      return '';
    }

    function extractPlainTextFromRaw(raw) {
      if (!raw) return '';
      const normalized = normalizeRawForParsing(raw);
      const boundaryText = extractPartByBoundary(normalized, 'text/plain');
      if (boundaryText) return boundaryText;
      const textMatch = normalized.match(/Content-Type:\\s*text\\/plain[\\s\\S]*?\\r?\\n\\r?\\n([\\s\\S]*?)(?:\\r?\\n--|\\r?\\nContent-Type:|$)/i);
      if (textMatch && textMatch[1]) return textMatch[1].trim();
      const headerSplit = normalized.split(/\\r?\\n\\r?\\n/);
      if (headerSplit.length > 1) return headerSplit.slice(1).join('\\n\\n').trim();
      return normalized.trim();
    }

    function extractHtmlFromRaw(raw) {
      if (!raw) return '';
      const normalized = normalizeRawForParsing(raw);
      const boundaryHtml = extractPartByBoundary(normalized, 'text/html');
      if (boundaryHtml) return boundaryHtml;
      const htmlMatch = normalized.match(/Content-Type:\\s*text\\/html[\\s\\S]*?\\r?\\n\\r?\\n([\\s\\S]*?)(?:\\r?\\n--|\\r?\\nContent-Type:|$)/i);
      if (htmlMatch && htmlMatch[1]) return htmlMatch[1].trim();
      return '';
    }

    function getDisplayText(email) {
      let text = (email.text || '').toString();
      if (looksLikeRawEmail(text)) {
        text = extractPlainTextFromRaw(text);
      }
      return text;
    }

    function getPreview(email) {
      const text = getDisplayText(email).replace(/\\s+/g, ' ').trim();
      if (text) return text.slice(0, 140);
      const html = (email.html || '').toString();
      if (!html) return '';
      return html.replace(/<[^>]+>/g, ' ').replace(/\\s+/g, ' ').trim().slice(0, 140);
    }

    function buildEmailSrcdoc(email) {
      const baseCss = `
        html, body { margin: 0; padding: 0; background: #ffffff; }
        body { font-family: ${varSans()}; color: #111827; padding: 16px; line-height: 1.55; }
        pre { white-space: pre-wrap; word-break: break-word; font-family: ${varMono()}; font-size: 13px; line-height: 1.55; }
        a { color: #2563eb; }
        img { max-width: 100%; height: auto; }
      `.trim();

      let html = (email.html || '').toString().trim();
      let text = getDisplayText(email);

      // Fallback: if backend didn't extract HTML but raw is in text, try to pull HTML too.
      if (!html && looksLikeRawEmail((email.text || '').toString())) {
        html = extractHtmlFromRaw((email.text || '').toString()) || '';
      }

      if (html) {
        if (/<html[\\s>]/i.test(html)) return html;
        return `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>${baseCss}</style></head><body>${html}</body></html>`;
      }

      const safe = escapeHtml(text || 'No content');
      return `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>${baseCss}</style></head><body><pre>${safe}</pre></body></html>`;
    }

    function setActiveInbox(email) {
      state.activeInbox = email || '';
      els.activeChipText.textContent = state.activeInbox ? state.activeInbox : 'All inboxes';
      els.openInboxInput.value = state.activeInbox || '';
    }

    function renderAddresses() {
      const q = (state.addressSearch || '').trim().toLowerCase();
      const filtered = state.addresses.filter(a => !q || (a.email || '').toLowerCase().includes(q));

      els.addressCount.textContent = String(filtered.length);
      els.addressList.innerHTML = '';
      els.addressEmpty.style.display = filtered.length ? 'none' : 'block';

      for (const addr of filtered) {
        const item = document.createElement('div');
        item.className = 'address-item' + (addr.email === state.activeInbox ? ' active' : '');
        item.innerHTML = `
          <div class="address-main">
            <div class="address-email mono">${escapeHtml(addr.email)}</div>
            <div class="address-meta">${addr.expires_at ? ('Expires ' + escapeHtml(formatDate(addr.expires_at))) : 'No expiry'}</div>
          </div>
          <div class="pill ${addr.expires_at ? 'danger' : ''}">${addr.expires_at ? 'expiring' : 'saved'}</div>
        `;
        item.addEventListener('click', async () => {
          setActiveInbox(addr.email);
          await loadInbox();
        });
        els.addressList.appendChild(item);
      }
    }

    function renderMessageList() {
      const q = (state.messageSearch || '').trim().toLowerCase();
      const list = state.emails.filter(m => {
        if (!q) return true;
        const hay = [m.subject, m.from, m.to, getPreview(m)].join(' ').toLowerCase();
        return hay.includes(q);
      });

      els.messageList.innerHTML = '';
      els.inboxEmpty.style.display = list.length ? 'none' : 'block';

      for (const m of list) {
        const item = document.createElement('div');
        item.className = 'message-item' + (m.id === state.selectedId ? ' selected' : '');
        item.innerHTML = `
          <div class="message-main">
            <div class="message-subject">${escapeHtml(m.subject || '(No subject)')}</div>
            <div class="message-from">${escapeHtml(m.from || 'Unknown sender')} → <span class="mono">${escapeHtml(m.to || '')}</span></div>
            <div class="message-preview">${escapeHtml(getPreview(m) || '')}</div>
          </div>
          <div class="message-time">${escapeHtml(formatShortDate(m.received_at) || '')}</div>
        `;
        item.addEventListener('click', () => {
          state.selectedId = m.id;
          renderMessageList();
          renderViewer();
        });
        els.messageList.appendChild(item);
      }
    }

    function renderViewer() {
      const selected = state.emails.find(m => m.id === state.selectedId);
      if (!selected) {
        els.viewerSubject.textContent = 'Select a message';
        els.viewerMeta.innerHTML = '';
        els.viewerFrame.style.display = 'none';
        els.viewerEmpty.style.display = 'flex';
        els.viewerFrame.removeAttribute('srcdoc');
        return;
      }
      els.viewerSubject.textContent = selected.subject || '(No subject)';
      els.viewerMeta.innerHTML = `
        <span><strong>From</strong> ${escapeHtml(selected.from || 'Unknown')}</span>
        <span><strong>To</strong> <span class="mono">${escapeHtml(selected.to || '')}</span></span>
        <span><strong>Date</strong> ${escapeHtml(formatDate(selected.received_at) || '')}</span>
      `;
      els.viewerFrame.style.display = 'block';
      els.viewerEmpty.style.display = 'none';
      els.viewerFrame.srcdoc = buildEmailSrcdoc(selected);
    }

    async function refreshAddresses() {
      const data = await apiFetch('/portal/api/addresses');
      state.addresses = data.addresses || [];
      renderAddresses();
    }

    async function loadInbox() {
      const params = new URLSearchParams();
      if (state.activeInbox) params.append('email', state.activeInbox);
      const url = '/portal/api/inbox' + (params.toString() ? '?' + params.toString() : '');
      const data = await apiFetch(url);
      state.emails = data.emails || [];
      els.inboxSubtitle.textContent = state.activeInbox
        ? `Showing ${state.emails.length} message(s) for ${state.activeInbox}`
        : `Showing ${state.emails.length} message(s) from all inboxes`;
      if (state.emails.length && !state.emails.some(m => m.id === state.selectedId)) {
        state.selectedId = state.emails[0].id;
      }
      renderMessageList();
      renderViewer();
    }

    async function generateMailbox(mode) {
      const expiry = els.expirySelect.value || '';
      const body = {};
      if (expiry) body.expiry = expiry;
      if (mode === 'random') {
        body.random = true;
      } else {
        body.local_part = els.customHandleInput.value.trim();
      }
      const data = await apiFetch('/portal/api/generate', {
        method: 'POST',
        body: JSON.stringify(body)
      });
      if (data.email) {
        setActiveInbox(data.email);
        await refreshAddresses();
        await loadInbox();
        showToast('Mailbox ready: ' + data.email, 'ok');
      }
    }

    async function expireActiveInbox() {
      if (!state.activeInbox) {
        showToast('No active inbox selected', 'error');
        return;
      }
      await apiFetch('/portal/api/addresses/' + encodeURIComponent(state.activeInbox), { method: 'DELETE' });
      showToast('Expired: ' + state.activeInbox, 'ok');
      setActiveInbox('');
      state.selectedId = null;
      await refreshAddresses();
      await loadInbox();
    }

    async function unlock() {
      const pw = els.gatePassword.value.trim();
      if (!pw) {
        setGateError('Password required.');
        return;
      }
      state.portalPassword = pw;
      setGateError('');
      try {
        await refreshAddresses();
        await loadInbox();
        localStorage.setItem('portalPassword', pw);
        els.gate.style.display = 'none';
        showToast('Unlocked', 'ok');
      } catch (err) {
        if (String(err.message) === 'auth') {
          setGateError('Invalid password.');
        } else {
          setGateError('Could not reach the API. Try again.');
        }
        state.portalPassword = '';
      }
    }

    function signOut() {
      localStorage.removeItem('portalPassword');
      state.portalPassword = '';
      els.gatePassword.value = '';
      els.gate.style.display = 'flex';
      showToast('Signed out', 'ok');
    }

    async function copyActiveInbox() {
      if (!state.activeInbox) {
        showToast('No active inbox selected', 'error');
        return;
      }
      try {
        await navigator.clipboard.writeText(state.activeInbox);
        showToast('Copied: ' + state.activeInbox, 'ok');
      } catch (err) {
        showToast('Copy failed (browser blocked).', 'error');
      }
    }

    function initEvents() {
      document.getElementById('unlockBtn').addEventListener('click', unlock);
      document.getElementById('gateClearBtn').addEventListener('click', () => { els.gatePassword.value = ''; setGateError(''); });
      els.gatePassword.addEventListener('keydown', (e) => { if (e.key === 'Enter') unlock(); });

      document.getElementById('syncAddressesBtn').addEventListener('click', async () => {
        try { await refreshAddresses(); showToast('Addresses synced', 'ok'); } catch (err) { showToast('Failed to sync addresses', 'error'); }
      });

      document.getElementById('viewAllBtn').addEventListener('click', async () => {
        setActiveInbox('');
        state.selectedId = null;
        try { await loadInbox(); } catch (err) { if (String(err.message) === 'auth') signOut(); }
      });

      document.getElementById('openInboxBtn').addEventListener('click', async () => {
        const email = els.openInboxInput.value.trim();
        if (!email) return;
        setActiveInbox(email);
        state.selectedId = null;
        try { await loadInbox(); } catch (err) { if (String(err.message) === 'auth') signOut(); }
      });

      document.getElementById('generateRandomBtn').addEventListener('click', async () => {
        try { await generateMailbox('random'); } catch (err) { if (String(err.message) === 'auth') signOut(); else showToast(err.message || 'Generate failed', 'error'); }
      });
      document.getElementById('generateCustomBtn').addEventListener('click', async () => {
        try { await generateMailbox('custom'); } catch (err) { if (String(err.message) === 'auth') signOut(); else showToast(err.message || 'Create failed', 'error'); }
      });

      document.getElementById('refreshInboxBtn').addEventListener('click', async () => {
        try { await loadInbox(); showToast('Inbox refreshed', 'ok'); } catch (err) { if (String(err.message) === 'auth') signOut(); else showToast('Failed to refresh inbox', 'error'); }
      });

      document.getElementById('copyEmailBtn').addEventListener('click', copyActiveInbox);
      document.getElementById('expireInboxBtn').addEventListener('click', async () => {
        try { await expireActiveInbox(); } catch (err) { if (String(err.message) === 'auth') signOut(); else showToast('Expire failed', 'error'); }
      });

      document.getElementById('clearPasswordBtn').addEventListener('click', signOut);

      els.messageSearch.addEventListener('input', (e) => { state.messageSearch = e.target.value || ''; renderMessageList(); });
      els.addressSearch.addEventListener('input', (e) => { state.addressSearch = e.target.value || ''; renderAddresses(); });
    }

    async function bootstrap() {
      initEvents();
      const stored = localStorage.getItem('portalPassword');
      if (stored) {
        state.portalPassword = stored;
        els.gate.style.display = 'none';
        try {
          await refreshAddresses();
          await loadInbox();
        } catch (err) {
          els.gate.style.display = 'flex';
          state.portalPassword = '';
        }
      } else {
        els.gate.style.display = 'flex';
      }
    }

    bootstrap();
  </script>
</body>
</html>
